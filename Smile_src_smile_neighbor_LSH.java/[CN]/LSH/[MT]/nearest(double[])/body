{
  IntArrayList candidates=new IntArrayList();
  for (  Hash h : hash) {
    BucketEntry bucket=h.get(q);
    if (bucket != null) {
      int m=bucket.entry.size();
      for (int i=0; i < m; i++) {
        int index=bucket.entry.get(i);
        candidates.add(index);
      }
    }
  }
  Neighbor<double[],E> neighbor=new Neighbor<double[],E>(null,null,-1,Double.MAX_VALUE);
  int[] cand=candidates.toArray();
  Arrays.sort(cand);
  int prev=-1;
  for (  int index : cand) {
    if (index == prev) {
      continue;
    }
 else {
      prev=index;
    }
    double[] key=keys.get(index);
    if (q == key && identicalExcluded) {
      continue;
    }
    double distance=Math.distance(q,key);
    if (distance < neighbor.distance) {
      neighbor.index=index;
      neighbor.distance=distance;
      neighbor.key=key;
      neighbor.value=data.get(index);
    }
  }
  return neighbor;
}
